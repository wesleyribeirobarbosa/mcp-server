/**
 * MCP Client - Comunica√ß√£o HTTP com servidor backend
 * Cliente simplificado para Smart Cities Dashboard
 */

class MCPClient {
    constructor() {
        this.baseURL = 'http://localhost:3001/api';
        this.setupAxios();
    }

    /**
     * Configura o cliente Axios
     */
    setupAxios() {
        // Configura√ß√£o global do Axios
        axios.defaults.timeout = 60000; // 30 segundos
        axios.defaults.headers.common['Content-Type'] = 'application/json';
        
        // Interceptor para requests
        axios.interceptors.request.use(
            (config) => {
                console.log('üöÄ Request:', config.method?.toUpperCase(), config.url);
                return config;
            },
            (error) => {
                console.error('‚ùå Request Error:', error);
                return Promise.reject(error);
            }
        );

        // Interceptor para responses
        axios.interceptors.response.use(
            (response) => {
                console.log('‚úÖ Response:', response.status, response.config.url);
                return response;
            },
            (error) => {
                console.error('‚ùå Response Error:', error.response?.status, error.response?.data || error.message);
                return Promise.reject(error);
            }
        );
    }

    /**
     * Processa um prompt do usu√°rio
     */
    async processPrompt(prompt) {
        try {
            const response = await axios.post(`${this.baseURL}/prompt`, {
                prompt: prompt.trim()
            });

            return {
                success: true,
                data: response.data
            };
        } catch (error) {
            return {
                success: false,
                error: this.handleError(error),
                message: error.response?.data?.message || 'Erro ao processar prompt'
            };
        }
    }

    /**
     * Lista dispositivos de ilumina√ß√£o
     */
    async listLightingDevices(limit = 10, offset = 0) {
        try {
            const response = await axios.get(`${this.baseURL}/lighting/devices`, {
                params: { limit, offset }
            });

            return {
                success: true,
                data: response.data
            };
        } catch (error) {
            return {
                success: false,
                error: this.handleError(error),
                message: 'Erro ao listar dispositivos de ilumina√ß√£o'
            };
        }
    }

    /**
     * Obt√©m telemetria de ilumina√ß√£o
     */
    async getLightingTelemetry(deviceId, hours = 24) {
        try {
            const response = await axios.get(`${this.baseURL}/lighting/telemetry`, {
                params: { deviceId, hours }
            });

            return {
                success: true,
                data: response.data
            };
        } catch (error) {
            return {
                success: false,
                error: this.handleError(error),
                message: 'Erro ao obter telemetria de ilumina√ß√£o'
            };
        }
    }

    /**
     * Analisa consumo de energia
     */
    async analyzeEnergyConsumption(timeRange = '7d', region = null) {
        try {
            const params = { timeRange };
            if (region) params.region = region;

            const response = await axios.get(`${this.baseURL}/energy/consumption`, {
                params
            });

            return {
                success: true,
                data: response.data
            };
        } catch (error) {
            return {
                success: false,
                error: this.handleError(error),
                message: 'Erro ao analisar consumo de energia'
            };
        }
    }

    /**
     * Detecta vazamentos de √°gua
     */
    async detectWaterLeaks(region = null, severity = null) {
        try {
            const params = {};
            if (region) params.region = region;
            if (severity) params.severity = severity;

            const response = await axios.get(`${this.baseURL}/water/leaks`, {
                params
            });

            return {
                success: true,
                data: response.data
            };
        } catch (error) {
            return {
                success: false,
                error: this.handleError(error),
                message: 'Erro ao detectar vazamentos de √°gua'
            };
        }
    }

    /**
     * Analisa consumo de g√°s
     */
    async analyzeGasConsumption(timeRange = '7d', region = null) {
        try {
            const params = { timeRange };
            if (region) params.region = region;

            const response = await axios.get(`${this.baseURL}/gas/consumption`, {
                params
            });

            return {
                success: true,
                data: response.data
            };
        } catch (error) {
            return {
                success: false,
                error: this.handleError(error),
                message: 'Erro ao analisar consumo de g√°s'
            };
        }
    }

    /**
     * Obt√©m dashboard da cidade
     */
    async getCityDashboard(timeRange = 'day', includeAlerts = true) {
        try {
            const response = await axios.get(`${this.baseURL}/dashboard/city`, {
                params: { timeRange, includeAlerts }
            });

            return {
                success: true,
                data: response.data
            };
        } catch (error) {
            return {
                success: false,
                error: this.handleError(error),
                message: 'Erro ao obter dashboard da cidade'
            };
        }
    }

    /**
     * Obt√©m estat√≠sticas regionais
     */
    async getRegionalStatistics(timeRange = 'week') {
        try {
            const response = await axios.get(`${this.baseURL}/statistics/regional`, {
                params: { timeRange }
            });

            return {
                success: true,
                data: response.data
            };
        } catch (error) {
            return {
                success: false,
                error: this.handleError(error),
                message: 'Erro ao obter estat√≠sticas regionais'
            };
        }
    }

    /**
     * Obt√©m relat√≥rio de sa√∫de dos dispositivos
     */
    async getDeviceHealthReport() {
        try {
            const response = await axios.get(`${this.baseURL}/devices/health`);

            return {
                success: true,
                data: response.data
            };
        } catch (error) {
            return {
                success: false,
                error: this.handleError(error),
                message: 'Erro ao obter relat√≥rio de sa√∫de dos dispositivos'
            };
        }
    }

    /**
     * Predi√ß√£o de manuten√ß√£o
     */
    async predictMaintenance(deviceType = null, urgencyLevel = null) {
        try {
            const params = {};
            if (deviceType) params.deviceType = deviceType;
            if (urgencyLevel) params.urgencyLevel = urgencyLevel;

            const response = await axios.get(`${this.baseURL}/maintenance/predict`, {
                params
            });

            return {
                success: true,
                data: response.data
            };
        } catch (error) {
            return {
                success: false,
                error: this.handleError(error),
                message: 'Erro ao predizer manuten√ß√£o'
            };
        }
    }

    /**
     * Detec√ß√£o de anomalias
     */
    async getAnomalyDetection(timeRange = '24h', deviceType = null) {
        try {
            const params = { timeRange };
            if (deviceType) params.deviceType = deviceType;

            const response = await axios.get(`${this.baseURL}/anomalies/detect`, {
                params
            });

            return {
                success: true,
                data: response.data
            };
        } catch (error) {
            return {
                success: false,
                error: this.handleError(error),
                message: 'Erro ao detectar anomalias'
            };
        }
    }

    /**
     * Relat√≥rio de efici√™ncia energ√©tica
     */
    async getEnergyEfficiencyReport(timeRange = 'month') {
        try {
            const response = await axios.get(`${this.baseURL}/energy/efficiency`, {
                params: { timeRange }
            });

            return {
                success: true,
                data: response.data
            };
        } catch (error) {
            return {
                success: false,
                error: this.handleError(error),
                message: 'Erro ao obter relat√≥rio de efici√™ncia energ√©tica'
            };
        }
    }

    /**
     * Relat√≥rio de qualidade da √°gua
     */
    async getWaterQualityReport(region = null, timeRange = 'week') {
        try {
            const params = { timeRange };
            if (region) params.region = region;

            const response = await axios.get(`${this.baseURL}/water/quality`, {
                params
            });

            return {
                success: true,
                data: response.data
            };
        } catch (error) {
            return {
                success: false,
                error: this.handleError(error),
                message: 'Erro ao obter relat√≥rio de qualidade da √°gua'
            };
        }
    }

    /**
     * An√°lise correlacionada entre dispositivos
     */
    async getCrossDeviceAnalysis(timeRange = 'day', includeCorrelations = true) {
        try {
            const response = await axios.get(`${this.baseURL}/analysis/cross-device`, {
                params: { timeRange, includeCorrelations }
            });

            return {
                success: true,
                data: response.data
            };
        } catch (error) {
            return {
                success: false,
                error: this.handleError(error),
                message: 'Erro ao obter an√°lise correlacionada'
            };
        }
    }

    /**
     * Testa conectividade com o servidor
     */
    async testConnection() {
        try {
            const response = await axios.get(`${this.baseURL}/health`);
            return {
                success: true,
                data: response.data,
                message: 'Conex√£o com servidor OK'
            };
        } catch (error) {
            return {
                success: false,
                error: this.handleError(error),
                message: 'Erro de conex√£o com servidor'
            };
        }
    }

    /**
     * Trata erros das requisi√ß√µes HTTP
     */
    handleError(error) {
        if (error.response) {
            // Erro com resposta do servidor
            return {
                type: 'server_error',
                status: error.response.status,
                data: error.response.data,
                message: error.response.data?.message || `Erro ${error.response.status}`
            };
        } else if (error.request) {
            // Erro de rede
            return {
                type: 'network_error',
                message: 'Erro de conex√£o com o servidor. Verifique se o backend est√° rodando.'
            };
        } else {
            // Erro na configura√ß√£o da requisi√ß√£o
            return {
                type: 'config_error',
                message: error.message || 'Erro na configura√ß√£o da requisi√ß√£o'
            };
        }
    }

    /**
     * Formata dados para exibi√ß√£o nos cards de m√©tricas
     */
    formatMetricsData(data) {
        if (!data || !data.metrics) return [];

        return Object.entries(data.metrics).map(([key, value]) => ({
            label: this.formatMetricLabel(key),
            value: this.formatMetricValue(value),
            icon: this.getMetricIcon(key),
            color: this.getMetricColor(key)
        }));
    }

    /**
     * Formata labels de m√©tricas para exibi√ß√£o
     */
    formatMetricLabel(key) {
        const labels = {
            'total_devices': 'Total de Dispositivos',
            'active_devices': 'Dispositivos Ativos',
            'energy_consumption': 'Consumo de Energia',
            'water_leaks': 'Vazamentos Detectados',
            'gas_consumption': 'Consumo de G√°s',
            'efficiency_score': 'Score de Efici√™ncia',
            'alerts_count': 'Alertas Ativos',
            'avg_response_time': 'Tempo de Resposta'
        };
        return labels[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    /**
     * Formata valores de m√©tricas para exibi√ß√£o
     */
    formatMetricValue(value) {
        if (typeof value === 'number') {
            if (value > 1000000) {
                return `${(value / 1000000).toFixed(1)}M`;
            } else if (value > 1000) {
                return `${(value / 1000).toFixed(1)}K`;
            }
            return value.toLocaleString();
        }
        return value;
    }

    /**
     * Retorna √≠cone para tipos de m√©tricas
     */
    getMetricIcon(key) {
        const icons = {
            'total_devices': 'üì±',
            'active_devices': '‚úÖ',
            'energy_consumption': '‚ö°',
            'water_leaks': 'üíß',
            'gas_consumption': 'üî•',
            'efficiency_score': 'üìä',
            'alerts_count': '‚ö†Ô∏è',
            'avg_response_time': '‚è±Ô∏è'
        };
        return icons[key] || 'üìà';
    }

    /**
     * Retorna cor para tipos de m√©tricas
     */
    getMetricColor(key) {
        const colors = {
            'total_devices': '#3182ce',
            'active_devices': '#38a169',
            'energy_consumption': '#d69e2e',
            'water_leaks': '#e53e3e',
            'gas_consumption': '#dd6b20',
            'efficiency_score': '#805ad5',
            'alerts_count': '#e53e3e',
            'avg_response_time': '#319795'
        };
        return colors[key] || '#3182ce';
    }
}

// Exporta inst√¢ncia global do cliente MCP
window.mcpClient = new MCPClient();
